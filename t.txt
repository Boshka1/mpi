#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <omp.h>   // Подключение библиотеки OpenMP

int main(int argc, char *argv[]) {
    // Размер вектора. Берем 100 млн элементов, чтобы вычисления заняли заметное время
    long N = 100000000; 
    
    // Выделяем память под массив (в куче, так как массив большой ~800 МБ)
    double *vector = (double*)malloc(N * sizeof(double));
    if (vector == NULL) {
        printf("Ошибка выделения памяти!\n");
        return 1;
    }

    // Инициализация вектора (заполняем единицами)
    // Это тоже можно распараллелить, но нас интересует замер времени именно вычисления нормы
    #pragma omp parallel for
    for (long i = 0; i < N; i++) {
        vector[i] = 1.0;
    }

    double sum_squares = 0.0; // Переменная для накопления суммы квадратов
    double start_time, end_time;

    printf("Начало вычислений с использованием %d потоков...\n", omp_get_max_threads());

    // Засекаем время
    start_time = omp_get_wtime();

    // ПАРАЛЛЕЛЬНАЯ ОБЛАСТЬ
    // #pragma omp parallel for - указывает, что цикл for нужно разделить между потоками
    // reduction(+:sum_squares) - критически важная часть (объяснение ниже)
    #pragma omp parallel for reduction(+:sum_squares)
    for (long i = 0; i < N; i++) {
        sum_squares += vector[i] * vector[i];
    }

    // Вычисляем корень из суммы квадратов
    double result = sqrt(sum_squares);

    // Останавливаем время
    end_time = omp_get_wtime();

    printf("Результат (Эвклидова норма): %f\n", result);
    printf("Затраченное время: %f секунд\n", end_time - start_time);

    // Освобождаем память
    free(vector);

    return 0;
}



@echo off
echo Compiling...
gcc -fopenmp euclid.c -o euclid.exe

echo.
echo --- TEST 1: 1 Thread ---
set OMP_NUM_THREADS=1
euclid.exe

echo.
echo --- TEST 2: 4 Threads ---
set OMP_NUM_THREADS=4
euclid.exe

echo.
echo --- TEST 3: 8 Threads ---
set OMP_NUM_THREADS=8
euclid.exe

pause

@echo off
echo --- Compiling with MSVC ---
cl /openmp /nologo euclid.c
REM Если ошибка компиляции, попробуйте: cl /openmp /nologo euclid.cpp

echo.
echo =================================
echo TEST 1: 1 Thread (Serial)
set OMP_NUM_THREADS=1
euclid.exe
echo =================================

echo.
echo =================================
echo TEST 2: 4 Threads
set OMP_NUM_THREADS=4
euclid.exe
echo =================================

echo.
echo =================================
echo TEST 3: 8 Threads
set OMP_NUM_THREADS=8
euclid.exe
echo =================================

pause
